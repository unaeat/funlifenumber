<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="UTF-8">
	<title>ã€ç”Ÿå‘½è—åœ–ã€</title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

	<!-- ç”Ÿå‘½æ•¸å­—å€ -->
	<div class="bg-white shadow-lg rounded-2xl p-8 w-full max-w-lg mx-auto mt-8 space-y-6 text-center">
		<h2 class="text-2xl font-bold text-gray-800">ã€ç”Ÿå‘½å¯†ç¢¼ã€</h2>
		
		<form id="numForm" class="space-y-4 mt-6">
			<div>
				<input type="text" name="life_number" placeholder="e.g, 123456" required class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-300">
			</div>
			<button id="generateNumBtn" type="submit" class="w-full bg-purple-500 text-white rounded-lg p-2 hover:bg-purple-600 transition">è¨ˆç®—</button>
			<!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
			<p id="numErrorMsg" class="text-red-500 text-center mt-2 hidden"></p>
		</form>

		<!-- ç”Ÿå‘½å¯†ç¢¼é¡¯ç¤ºå€ -->
		<div id="lifePasswordOutput" class="hidden mt-4 text-center">
			<p id="lifePassword" class="text-xl text-purple-500"></p>
		</div>
	</div>

	<!-- PDF ç”¢ç”Ÿå€ -->
	<div class="bg-white shadow-lg rounded-2xl p-8 w-full max-w-lg mx-auto mt-8 space-y-6">
		<h2 class="text-2xl font-bold text-gray-800 text-center">ã€ç”Ÿå‘½è—åœ–ã€</h2>
		
		<form id="pdfForm" class="space-y-4 mt-6">
			<div>
				<label class="block text-gray-700 mb-1 font-bold">è‹±æ–‡åï¼ˆè­·ç…§ï¼‰</label>
				<input type="text" name="passport_name" placeholder="e.g, WANG,HSIAO-MING å¤§å°å¯«ã€ç¬¦è™Ÿä¸å½±éŸ¿" required class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-300">
			</div>

			<div>
				<label class="block text-gray-700 mb-1 font-bold">è‹±æ–‡åï¼ˆå°åï¼‰</label>
				<input type="text" name="nickname" placeholder="e.g, Apple" required class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-300">
			</div>

			<div>
				<label class="block text-gray-700 mb-1 font-bold">å‡ºç”Ÿæ™‚é–“ï¼ˆYYYYMMDD hhmmï¼‰</label>
				<input type="text" name="birthday_time" placeholder="e.g, 2025-04-26 01:16 -> 20250426 0116" required class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-300">
			</div>

			<button id="generatePdfBtn" type="submit" class="w-full bg-blue-500 text-white rounded-lg p-2 hover:bg-blue-600 transition">ç”¢ç”Ÿ PDF</button>
			<!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
			<p id="pdfErrorMsg" class="text-red-500 text-center mt-2 hidden"></p>
		</form>
	</div>

	<!-- PDF é è¦½å€ -->
	<div id="preview" class="flex-1 hidden flex flex-col p-6">
		<iframe id="pdfViewer" class="w-full h-full flex-1 rounded-lg border-2 border-gray-300"></iframe>
		<div class="mt-4 flex justify-center">
			<button id="downloadBtn" class="bg-green-500 text-white rounded-lg px-6 py-2 hover:bg-green-600 transition">ä¸‹è¼‰</button>
		</div>
	</div>

	<script>
		// ç”¢ç”Ÿ PDF è¡¨å–®æäº¤
		document.getElementById('pdfForm').addEventListener('submit', async (e) => {
			e.preventDefault();

			const form = e.target;
			const formData = new FormData(form);
			const errorMsg = document.getElementById('pdfErrorMsg');
			const generatePdfBtn = document.getElementById('generatePdfBtn');

			const birthdayTime = formData.get('birthday_time')?.replace(/\s+/g, '') || 'generated';

			const preview = document.getElementById('preview');
			const pdfViewer = document.getElementById('pdfViewer');
			const downloadBtn = document.getElementById('downloadBtn');

			// æäº¤å‰å…ˆæ¸…ç©ºå‰ä¸€æ¬¡çš„ PDF
			preview.classList.add('hidden');
			pdfViewer.src = '';

			errorMsg.classList.add('hidden');
			errorMsg.textContent = '';

			try {
				const response = await fetch('https://funlifenumber.onrender.com/generate-pdf', {
					method: 'POST',
					body: formData
				});

                if (response.ok) {
					const isLeapBaby = response.headers.get('X-IsLeap') === 'true';
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);

                    // é¡¯ç¤º PDF é è¦½
                    preview.classList.remove('hidden');
                    pdfViewer.src = url + '#view=FitH&navpanes=0&toolbar=0';

					if (isLeapBaby) {
						const congrats = document.createElement('div');
						congrats.innerHTML = `
							<div class="bg-gradient-to-r from-purple-400 via-pink-400 to-red-400 text-white text-lg font-bold rounded-xl p-4 shadow-lg animate-bounce">
								ğŸ‰ æ­å–œä½ æ˜¯æ½¤æœˆå¯¶å¯¶ï¼ä¸€ä½è¶•é€²åº¦çš„éˆé­‚ ğŸ‰
							</div>
						`;
						congrats.className = 'flex justify-center mt-4';
						preview.insertBefore(congrats, pdfViewer);
					}

                    // ä¸‹è¼‰æŒ‰éˆ•è¨­å®š
                    downloadBtn.onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${birthdayTime}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    };

                } else if (response.status === 400) {
                    errorMsg.textContent = 'å‡ºç”Ÿæ™‚é–“éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™ï¼';
                    errorMsg.classList.remove('hidden');
                } else if (response.status === 500) {
                    errorMsg.textContent = 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    errorMsg.classList.remove('hidden');
                } else {
                    errorMsg.textContent = 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚';
                    errorMsg.classList.remove('hidden');
                }
            } catch (err) {
                errorMsg.textContent = 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚';
                errorMsg.classList.remove('hidden');
            }
		});

		// ç”Ÿå‘½æ•¸å­—è¡¨å–®æäº¤
		document.getElementById('numForm').addEventListener('submit', async (e) => {
			e.preventDefault();

			const form = e.target;
			const formData = new FormData(form);
			const errorMsg = document.getElementById('numErrorMsg');
			const generateNumBtn = document.getElementById('generateNumBtn');
			const lifePasswordOutput = document.getElementById('lifePasswordOutput');
			const lifePassword = document.getElementById('lifePassword');

			// æ¸…ç©ºéŒ¯èª¤è¨Šæ¯èˆ‡å‰ä¸€æ¬¡çµæœ
			errorMsg.classList.add('hidden');
			errorMsg.textContent = '';
			lifePasswordOutput.classList.add('hidden');
			lifePassword.textContent = '';

			try {
				const response = await fetch('https://funlifenumber.onrender.com/generate-num', {
					method: 'POST',
					body: formData
				});

                if (response.ok) {
                    const data = await response.json();
                    lifePasswordOutput.classList.remove('hidden');
                    lifePassword.textContent = data.lifePassword || 'ç„¡æ³•è¨ˆç®—ç”Ÿå‘½å¯†ç¢¼';
                } else if (response.status === 400) {
                    errorMsg.textContent = 'ç”Ÿå‘½æ•¸å­—æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™ï¼';
                    errorMsg.classList.remove('hidden');
                } else if (response.status === 500) {
                    errorMsg.textContent = 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    errorMsg.classList.remove('hidden');
                } else {
                    errorMsg.textContent = 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚';
                    errorMsg.classList.remove('hidden');
                }
            } catch (err) {
                errorMsg.textContent = 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚';
                errorMsg.classList.remove('hidden');
            }
		});
	</script>
</body>
</html>
